<div ngbAccordionItem [collapsed]="false">
  <h2 ngbAccordionHeader>
    <button ngbAccordionButton>
      {{ request().receivedAt | date:'shortTime' }}
      &nbsp;
      @if (request().isPersonalSign) {
        <b>Request to sign personal message</b>
      } @else if (request().isTransaction) {
        <b>Request to sign transaction</b>
      }
    </button>
  </h2>
  <div ngbAccordionCollapse>
    <div ngbAccordionBody>
      <ng-template>
        @if (request().isPersonalSign) {
          <div class="alert alert-secondary" role="alert">
            <pre class="word-wrap">{{ request().personalSignMessage }}</pre>
          </div>
        } @else if (request().isTransaction) {
          <div class="mb-2">
            <transaction-form
              [request]="request().transactionParams"
              (transaction)="requestedTransaction.set($event)"
            ></transaction-form>
          </div>
        }
        <p>
          In order to get a signature for this message, the owner of the Potato
          needs to call <b>authorizeSignature</b> on the
          <a href="https://arbitrum.blockscout.com/address/{{ request().potato.contractAddress }}">HotPotatoNFT</a>
          contract as follows:
        </p>
        <div class="alert alert-secondary mt-2" style="padding-bottom: 0">
          <!-- TODO: Rename to authorizeSignature() -->
          <pre>signHash({{ request().potato.tokenId }}, {{ requestedHash() || "(Invalid transaction)" }})</pre>
        </div>

        <div class="btn-group" ngbDropdown placement="bottom-end">
          <button [disabled]="!requestedHash()" class="btn btn-primary" type="button" (click)="authorizeSignature()">
            Authorize Signature
          </button>
          <button class="btn btn-primary dropdown-toggle dropdown-toggle-split" type="button" ngbDropdownToggle>
            <span class="visually-hidden">Toggle Dropdown</span>
          </button>
          <div class="dropdown-menu dropdown-menu-end" ngbDropdownMenu>
            <button class="dropdown-item" type="button" (click)="promptTransactionHash()">
              Use Transaction Hash
            </button>
          </div>
        </div>

        @if (authorization().error) {
          <div class="alert alert-danger mt-3">
            <b>Authorization:</b>
            {{ authorization().error }}
          </div>
        } @else if (authorization().progress) {
          <div class="alert alert-info mt-3">
            <b>Authorization:</b>
            {{ authorization().progress }}
          </div>
        } @else if (authorization().success) {
          <div class="alert alert-success mt-3">
            <b>Signature authorized:</b>
            Signature number {{ authorization().success!.signatureId }} in block number
            {{ authorization().success!.blockNumber }}
            (View <a href="https://arbitrum.blockscout.com/tx/{{ authorization().success!.transactionHash }}" target="_blank">transaction</a>)
          </div>

          @if (signature().error) {
            <div class="alert alert-danger mt-3">
              <b>Signing:</b>
              {{ signature().error }}
            </div>
          } @else if (signature().progress) {
            <div class="alert alert-info mt-3">
              <b>Signing:</b>
              {{ signature().progress }}
            </div>
          } @else if (signature().success) {
            <div class="alert alert-success mt-3">
              <b>Signature fetched and verified:</b>
              {{ signature().success!.serialized }}
            </div>

            @if (broadcast().error) {
              <div class="alert alert-danger mt-3">
                <b>Broadcasting transaction:</b>
                {{ broadcast().error }}
              </div>
            } @else if (broadcast().progress) {
              <div class="alert alert-info mt-3">
                <b>Broadcasting transaction:</b>
                {{ broadcast().progress }}
              </div>
            } @else if (broadcast().success) {
              <div class="alert alert-success mt-3">
                <b>Transaction broadcasted successfully!</b>
                TxHash: {{ broadcast().success }}
              </div>
            }
          }
        }
      </ng-template>
    </div>
  </div>
</div>
